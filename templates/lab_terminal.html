<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ lab_session.lab.name }} - Lab Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/xterm@5.3.0/css/xterm.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0;
        padding: 0;
        background: #0d1117;
        font-family: "Cascadia Code", "Consolas", "Monaco", monospace;
        color: #c9d1d9;
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .lab-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .lab-info h1 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 600;
      }

      .lab-info p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 0.9rem;
      }

      .lab-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      /* PDF Viewer Modal */
      .pdf-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }

      .pdf-modal.show {
        display: flex;
      }

      .pdf-content {
        background: #1f2937;
        border-radius: 12px;
        width: 90%;
        height: 90%;
        display: flex;
        flex-direction: column;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }

      .pdf-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 15px 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
      }

      .pdf-header h3 {
        margin: 0;
        font-size: 1.2rem;
      }

      .pdf-viewer {
        flex: 1;
        background: white;
        border-radius: 0 0 12px 12px;
        overflow: hidden;
      }

      .pdf-viewer iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      /* Output Result Display */
      .output-result {
        display: none;
        position: fixed;
        top: 70px;
        right: 20px;
        width: 400px;
        max-height: 500px;
        background: #1f2937;
        border: 2px solid #667eea;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow: hidden;
      }

      .output-result.show {
        display: block;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateX(450px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .output-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 12px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
      }

      .output-header h4 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
      }

      .output-body {
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
        color: #c9d1d9;
        font-family: "Cascadia Code", "Consolas", monospace;
        font-size: 0.9rem;
        line-height: 1.6;
      }

      .output-body pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        background: #0d1117;
        padding: 10px;
        border-radius: 6px;
        border-left: 3px solid #667eea;
      }

      .submit-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }

      .submit-modal.show {
        display: flex;
      }

      .submit-content {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 12px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }

      .submit-content h2 {
        color: #58a6ff;
        margin-bottom: 20px;
      }

      .checkpoint-input {
        margin-bottom: 15px;
      }

      .checkpoint-input label {
        display: block;
        color: #8b949e;
        margin-bottom: 5px;
        font-size: 0.9rem;
      }

      .checkpoint-input input {
        width: 100%;
        padding: 10px;
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 6px;
        color: #c9d1d9;
        font-family: "Consolas", monospace;
      }

      .checkpoint-input input:focus {
        outline: none;
        border-color: #58a6ff;
      }

      .result-section {
        margin-top: 20px;
        padding: 15px;
        background: #0d1117;
        border-radius: 8px;
        border-left: 4px solid #58a6ff;
      }

      .result-item {
        padding: 10px;
        margin: 10px 0;
        border-radius: 6px;
        background: #161b22;
      }

      .result-item.passed {
        border-left: 4px solid #3fb950;
      }

      .result-item.failed {
        border-left: 4px solid #f85149;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-badge.in-progress {
        background: #ffc107;
        color: #333;
      }

      .btn-control {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }

      .btn-control:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        transform: translateY(-1px);
      }

      .terminal-container {
        flex: 1;
        background: #0d1117;
        position: relative;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .terminal-wrapper {
        flex: 1;
        padding: 20px;
        background: #0d1117;
        overflow: auto;
        min-height: 0;
      }

      #terminal {
        height: 100%;
        min-height: 100%;
        background: #0d1117;
      }

      .security-notice {
        background: rgba(255, 193, 7, 0.1);
        border: 1px solid #ffc107;
        color: #ffc107;
        padding: 10px 20px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Terminal scrollbar */
      .xterm .xterm-viewport::-webkit-scrollbar {
        width: 8px;
      }

      .xterm .xterm-viewport::-webkit-scrollbar-track {
        background: #161b22;
      }

      .xterm .xterm-viewport::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 4px;
      }

      .xterm .xterm-viewport::-webkit-scrollbar-thumb:hover {
        background: #7c8df0;
      }

      /* Loading overlay */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(13, 17, 23, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: opacity 0.3s ease;
      }

      .loading-content {
        text-align: center;
        color: #c9d1d9;
      }

      .loading-content i {
        font-size: 3rem;
        color: #667eea;
        margin-bottom: 20px;
        animation: spin 2s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .connection-status {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 8px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 100;
        transition: all 0.3s ease;
      }

      .connection-status.connected {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border: 1px solid #28a745;
      }

      .connection-status.connecting {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid #ffc107;
        animation: pulse 2s infinite;
      }

      .connection-status.disconnected {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border: 1px solid #dc3545;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <!-- Lab Header -->
    <div class="lab-header">
      <div class="lab-info">
        <h1>
          <i class="fas fa-flask me-2"></i>
          {{ lab_session.lab.name }}
        </h1>
        <p>{{ lab_session.lab.description }}</p>
      </div>

      <div class="lab-controls">
        <span class="status-badge {{ lab_session.status }}"
          >{{ lab_session.status.replace('_', ' ').title() }}</span
        >
        {% if lab_session.lab.pdf_instruction_url %}
        <button class="btn btn-control" onclick="showPDF()">
          <i class="fas fa-file-pdf me-1"></i>Instructions
        </button>
        {% endif %}
        <button class="btn btn-control" onclick="showHelp()">
          <i class="fas fa-question-circle me-1"></i>Help
        </button>
        <button class="btn btn-control" onclick="submitLab()">
          <i class="fas fa-paper-plane me-1"></i>Submit
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-control">
          <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
        </a>
      </div>
    </div>

    <!-- Output Result Display -->
    <div class="output-result" id="outputResult">
      <div class="output-header">
        <h4><i class="fas fa-terminal me-2"></i>Expected Output</h4>
        <button
          class="btn btn-sm"
          onclick="closeOutput()"
          style="
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
          "
        >
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="output-body">
        <pre>
{{ lab_session.success_start_lab_output or 'No expected output defined for this lab.' }}</pre
        >
      </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div class="pdf-modal" id="pdfModal">
      <div class="pdf-content">
        <div class="pdf-header">
          <h3><i class="fas fa-file-pdf me-2"></i>Lab Instructions</h3>
          <button
            class="btn btn-sm"
            onclick="closePDF()"
            style="
              background: rgba(255, 255, 255, 0.2);
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 6px;
            "
          >
            <i class="fas fa-times me-2"></i>Close
          </button>
        </div>
        <div class="pdf-viewer">
          {% if lab_session.lab.pdf_instruction_url %}
          <iframe
            src="{{ lab_session.lab.pdf_instruction_url }}"
            type="application/pdf"
          ></iframe>
          {% else %}
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: center;
              height: 100%;
              color: #6b7280;
            "
          >
            <p>No PDF instructions available for this lab.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Security Notice -->
    <div class="security-notice">
      <i class="fas fa-shield-alt"></i>
      <span
        >Security Mode: Commands are validated and restricted to lab resources
        only.</span
      >
    </div>

    <!-- Terminal Container -->
    <div class="terminal-container">
      <div class="connection-status connecting" id="connectionStatus">
        <i class="fas fa-wifi me-1"></i>Connecting...
      </div>

      <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
          <i class="fas fa-cog"></i>
          <h4>Initializing Lab Environment</h4>
          <p>Setting up secure terminal session...</p>
        </div>
      </div>

      <div class="terminal-wrapper">
        <div id="terminal"></div>
      </div>
    </div>

    <!-- Submit Modal -->
    <div
      class="submit-modal"
      id="submitModal"
      onclick="event.stopPropagation();"
    >
      <div class="submit-content" onclick="event.stopPropagation();">
        <h2><i class="fas fa-paper-plane me-2"></i>Submit Lab</h2>

        {% if lab_session.lab.num_checkpoints > 0 %}
        <div id="checkpointForm">
          <p class="mb-3">
            This lab requires {{ lab_session.lab.num_checkpoints }} checkpoint
            answers. Please enter your findings below:
          </p>

          <form id="submitForm">
            {% for i in range(1, lab_session.lab.num_checkpoints + 1) %}
            <div class="checkpoint-input">
              <label for="checkpoint_{{ i }}">
                <i class="fas fa-check-circle me-1"></i>Checkpoint {{ i }}:
              </label>
              <input
                type="text"
                id="checkpoint_{{ i }}"
                name="checkpoint_{{ i }}"
                placeholder="Enter your answer..."
                required
              />
            </div>
            {% endfor %}

            <div class="checkpoint-input">
              <label for="notes">
                <i class="fas fa-sticky-note me-1"></i>Notes (optional):
              </label>
              <textarea
                id="notes"
                name="notes"
                rows="3"
                style="
                  width: 100%;
                  padding: 10px;
                  background: #0d1117;
                  border: 1px solid #30363d;
                  border-radius: 6px;
                  color: #c9d1d9;
                  font-family: 'Consolas', monospace;
                "
                placeholder="Add any additional notes about your solution..."
              ></textarea>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px">
              <button type="submit" class="btn btn-primary" style="flex: 1">
                <i class="fas fa-paper-plane me-1"></i>Submit Lab
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                onclick="closeSubmitModal()"
              >
                <i class="fas fa-times me-1"></i>Cancel
              </button>
            </div>
          </form>
        </div>

        <div id="submitResults" style="display: none">
          <!-- Results will be inserted here -->
        </div>
        {% else %}
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          This lab does not have checkpoints configured. Contact your instructor
          for submission instructions.
        </div>
        <button class="btn btn-secondary mt-3" onclick="closeSubmitModal()">
          <i class="fas fa-times me-1"></i>Close
        </button>
        {% endif %}
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://unpkg.com/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
              // Initialize components
              const socket = io();
              const labSessionId = {{ lab_session.id }};

              // Terminal configuration
              const terminal = new Terminal({
                  cursorBlink: true,
                  cursorStyle: "block",
                  theme: {
                      background: "#0d1117",
                      foreground: "#c9d1d9",
                      cursor: "#667eea",
                      cursorAccent: "#0d1117",
                      selection: "rgba(102, 126, 234, 0.3)",
                      black: "#484f58",
                      red: "#ff7b72",
                      green: "#7ce38b",
                      yellow: "#ffc777",
                      blue: "#67b7ff",
                      magenta: "#dcbdfb",
                      cyan: "#7ee2f7",
                      white: "#e6edf3",
                      brightBlack: "#6e7681",
                      brightRed: "#ffa198",
                      brightGreen: "#56d364",
                      brightYellow: "#e3b341",
                      brightBlue: "#79c0ff",
                      brightMagenta: "#d2a8ff",
                      brightCyan: "#a5f3fc",
                      brightWhite: "#f0f6fc"
                  },
                  fontSize: 14,
                  lineHeight: 1.2,
                  letterSpacing: 0.5,
                  fontFamily: '"Cascadia Code", "Consolas", "SF Mono", "Monaco", monospace',
                  fontWeight: 'normal',
                  fontWeightBold: 'bold',
                  scrollback: 5000,
                  bellStyle: "none",
                  allowTransparency: false,
                  convertEol: true,
                  fastScrollModifier: "alt",
                  rightClickSelectsWord: true,
                  wordSeparator: " ()[]{}',\"`",
                  tabStopWidth: 4
              });

              // Add FitAddon for auto-sizing
              const fitAddon = new FitAddon.FitAddon();
              terminal.loadAddon(fitAddon);

              // DOM elements
              const loadingOverlay = document.getElementById('loadingOverlay');
              const connectionStatus = document.getElementById('connectionStatus');

              // Attach terminal to DOM
              terminal.open(document.getElementById('terminal'));

              // Auto-fit terminal using FitAddon
              function fitTerminal() {
                  try {
                      fitAddon.fit();
                  } catch (e) {
                      console.warn('Could not fit terminal:', e);
                  }
              }

              // Initialize terminal size
              setTimeout(() => {
                  fitTerminal();
                  terminal.focus();
              }, 100);

              // Handle window resize
              window.addEventListener('resize', () => {
                  setTimeout(() => {
                      fitTerminal();
                      // Send resize event to server (for pty)
                      socket.emit('terminal_resize', {
                          cols: terminal.cols,
                          rows: terminal.rows
                      });
                  }, 100);
              });

              // Terminal input handling
              terminal.onData((data) => {
                  socket.emit('terminal_input', { data: data });
              });

              // Keyboard shortcuts
              terminal.attachCustomKeyEventHandler((event) => {
                  // Ctrl+Shift+C for copy
                  if (event.ctrlKey && event.shiftKey && event.code === 'KeyC') {
                      document.execCommand('copy');
                      return false;
                  }

                  // Ctrl+Shift+V for paste
                  if (event.ctrlKey && event.shiftKey && event.code === 'KeyV') {
                      navigator.clipboard.readText().then(text => {
                          socket.emit('terminal_input', { data: text });
                      });
                      return false;
                  }

                  // Ctrl+L for clear
                  if (event.ctrlKey && event.code === 'KeyL') {
                      socket.emit('terminal_input', { data: 'clear\r' });
                      return false;
                  }

                  return true;
              });

              // Socket event handlers
              socket.on('connect', () => {
                  updateConnectionStatus('connecting', 'Connecting...');
                  socket.emit('start_terminal', { lab_session_id: labSessionId });
              });

              socket.on('disconnect', () => {
                  updateConnectionStatus('disconnected', 'Disconnected');
              });

              socket.on('terminal_ready', () => {
                  updateConnectionStatus('connected', 'Connected');
                  hideLoading();
                  terminal.focus();

                  // Send initial terminal size (for pty)
                  socket.emit('terminal_resize', {
                      cols: terminal.cols,
                      rows: terminal.rows
                  });

                  // Show output result if available (after run commands complete)
                  {% if lab_session.lab.output_result %}
                  setTimeout(() => {
                      showOutput();
                  }, 2000); // Show after 2 seconds to let run commands finish
                  {% endif %}
              });

              socket.on('terminal_output', (data) => {
                  terminal.write(data.data);
              });

              socket.on('terminal_clear', () => {
                  terminal.clear();
                  terminal.reset();
              });

              socket.on('terminal_error', (data) => {
                  terminal.write(`\r\n\x1b[31m‚ùå Error: ${data.error}\x1b[0m\r\n`);
                  updateConnectionStatus('disconnected', 'Error');
              });

              // Helper functions
              function updateConnectionStatus(status, text) {
                  connectionStatus.className = `connection-status ${status}`;
                  connectionStatus.innerHTML = `<i class="fas fa-wifi me-1"></i>${text}`;
              }

              function hideLoading() {
                  loadingOverlay.style.opacity = '0';
                  setTimeout(() => {
                      loadingOverlay.style.display = 'none';
                  }, 300);
              }

              function showHelp() {
                  const helpText = `
      üß™ Lab Terminal Help
      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

      üìã Available Commands:
        ls, cat, grep, find, pwd, whoami, cd
        python3, gcc, make (if applicable)

      üîí Security Features:
        ‚Ä¢ Commands are validated for safety
        ‚Ä¢ Access restricted to lab resources only
        ‚Ä¢ All commands are logged

      ‚å®Ô∏è  Keyboard Shortcuts:
        ‚Ä¢ Ctrl+Shift+C: Copy selected text
        ‚Ä¢ Ctrl+Shift+V: Paste text
        ‚Ä¢ Ctrl+L: Clear terminal

      üí° Tips:
        ‚Ä¢ Use 'ls' to explore available files
        ‚Ä¢ Check README.md for lab instructions
        ‚Ä¢ Use 'cd' to navigate directories

      ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
      `;
                  terminal.write(helpText);
              }

              function submitLab() {
                  const modal = document.getElementById('submitModal');
                  modal.classList.add('show');

                  // Disable terminal input when modal is open
                  terminal.setOption('disableStdin', true);

                  // Blur terminal to prevent any focus
                  const terminalElement = document.getElementById('terminal');
                  if (terminalElement) {
                      terminalElement.blur();
                      // Prevent terminal from receiving any events
                      terminalElement.style.pointerEvents = 'none';
                  }

                  // Also disable the terminal wrapper
                  const terminalWrapper = document.querySelector('.terminal-wrapper');
                  if (terminalWrapper) {
                      terminalWrapper.style.pointerEvents = 'none';
                  }

                  // Prevent body scrolling
                  document.body.style.overflow = 'hidden';

                  // Focus on first checkpoint input
                  setTimeout(() => {
                      const firstInput = document.getElementById('checkpoint_1');
                      if (firstInput) firstInput.focus();
                  }, 100);
              }

              function closeSubmitModal() {
                  const modal = document.getElementById('submitModal');
                  modal.classList.remove('show');

                  // Re-enable terminal input
                  terminal.setOption('disableStdin', false);

                  // Restore terminal interaction
                  const terminalElement = document.getElementById('terminal');
                  if (terminalElement) {
                      terminalElement.style.pointerEvents = 'auto';
                  }

                  // Restore terminal wrapper interaction
                  const terminalWrapper = document.querySelector('.terminal-wrapper');
                  if (terminalWrapper) {
                      terminalWrapper.style.pointerEvents = 'auto';
                  }

                  // Restore body scrolling
                  document.body.style.overflow = 'auto';

                  terminal.focus();

                  // Reset form
                  const form = document.getElementById('submitForm');
                  if (form) form.reset();
                  // Hide results
                  document.getElementById('submitResults').style.display = 'none';
                  document.getElementById('checkpointForm').style.display = 'block';
              }

              function showPDF() {
                  const modal = document.getElementById('pdfModal');
                  modal.classList.add('show');
                  terminal.setOption('disableStdin', true);

                  // Prevent terminal from receiving any events
                  const terminalElement = document.getElementById('terminal');
                  if (terminalElement) {
                      terminalElement.style.pointerEvents = 'none';
                  }
              }

              function closePDF() {
                  const modal = document.getElementById('pdfModal');
                  modal.classList.remove('show');
                  terminal.setOption('disableStdin', false);

                  // Restore terminal interaction
                  const terminalElement = document.getElementById('terminal');
                  if (terminalElement) {
                      terminalElement.style.pointerEvents = 'auto';
                  }

                  terminal.focus();
              }

              function showOutput() {
                  const outputDiv = document.getElementById('outputResult');
                  outputDiv.classList.add('show');
              }

              function closeOutput() {
                  const outputDiv = document.getElementById('outputResult');
                  outputDiv.classList.remove('show');
              }

              // Handle form submission
              const submitForm = document.getElementById('submitForm');
              if (submitForm) {
                  submitForm.addEventListener('submit', async (e) => {
                      e.preventDefault();

                      // Collect checkpoint answers
                      const checkpointAnswers = [];
                      const numCheckpoints = {{ lab_session.lab.num_checkpoints }};

                      for (let i = 1; i <= numCheckpoints; i++) {
                          const input = document.getElementById(`checkpoint_${i}`);
                          checkpointAnswers.push(input.value.trim());
                      }

                      const notes = document.getElementById('notes').value.trim();

                      // Disable submit button
                      const submitBtn = e.target.querySelector('button[type="submit"]');
                      submitBtn.disabled = true;
                      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Submitting...';

                      try {
                          const response = await fetch('/api/lab/{{ lab_session.id }}/submit', {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                              },
                              body: JSON.stringify({
                                  checkpoint_answers: checkpointAnswers,
                                  notes: notes
                              })
                          });

                          const result = await response.json();

                          if (response.ok) {
                              // Show results
                              displayResults(result);
                          } else {
                              alert('Error: ' + (result.error || 'Failed to submit lab'));
                              submitBtn.disabled = false;
                              submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Submit Lab';
                          }
                      } catch (error) {
                          console.error('Submit error:', error);
                          alert('Failed to submit lab. Please try again.');
                          submitBtn.disabled = false;
                          submitBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Submit Lab';
                      }
                  });
              }

              function displayResults(result) {
                  // Hide form
                  document.getElementById('checkpointForm').style.display = 'none';

                  // Show results
                  const resultsDiv = document.getElementById('submitResults');
                  resultsDiv.style.display = 'block';

                  const scorePercentage = Math.round((result.score / result.max_score) * 100);
                  const passed = result.passed || false;
                  const scoreColor = passed ? '#3fb950' : '#f85149';
                  const statusBadge = passed
                      ? '<span style="background: #3fb950; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;"><i class="fas fa-check-circle me-1"></i>PASSED</span>'
                      : '<span style="background: #f85149; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold;"><i class="fas fa-times-circle me-1"></i>FAILED</span>';

                  let html = `
                      <div class="result-section">
                          <div style="text-align: center; margin-bottom: 20px;">
                              ${statusBadge}
                          </div>
                          <h3 style="color: ${scoreColor}; text-align: center;">
                              <i class="fas fa-trophy me-2"></i>
                              Score: ${result.score} / ${result.max_score} (${scorePercentage}%)
                          </h3>
                          <p style="text-align: center;">
                              Required: ${result.minimum_score || 0} points to pass
                          </p>
                          <p style="text-align: center;">
                              Checkpoints: ${result.passed_checkpoints} / ${result.total_checkpoints} passed
                              ‚Ä¢ Points: ${result.earned_points || 0} / ${result.total_points || 0}
                          </p>
                      </div>

                      <div class="mt-3">
                          <h4>Checkpoint Results:</h4>
                  `;

                  result.results.forEach((r, index) => {
                      const statusIcon = r.passed ? 'fa-check-circle' : 'fa-times-circle';
                      const statusColor = r.passed ? '#3fb950' : '#f85149';
                      const statusClass = r.passed ? 'passed' : 'failed';

                      html += `
                          <div class="result-item ${statusClass}">
                              <div style="display: flex; justify-content: space-between; align-items: center;">
                                  <strong>
                                      <i class="fas ${statusIcon}" style="color: ${statusColor};"></i>
                                      Checkpoint ${r.checkpoint}
                                  </strong>
                                  <span style="color: ${statusColor};">
                                      ${r.earned_points || 0} / ${r.points || 0} points
                                  </span>
                              </div>
                              <div style="margin-top: 8px; font-size: 0.9rem; color: #8b949e;">
                                  <div>Your answer: <code style="color: #c9d1d9;">${r.student_answer}</code></div>
                                  ${r.decoded_answer ? `<div>Decoded: <code style="color: #c9d1d9;">${r.decoded_answer}</code></div>` : ''}
                                  <div style="margin-top: 5px; color: ${statusColor};">${r.message}</div>
                              </div>
                          </div>
                      `;
                  });

                  html += `
                      </div>
                      <div style="margin-top: 20px; display: flex; gap: 10px;">
                          <button class="btn btn-primary" onclick="window.location.href='/dashboard'">
                              <i class="fas fa-home me-1"></i>Back to Dashboard
                          </button>
                          <button class="btn btn-secondary" onclick="closeSubmitModal()">
                              <i class="fas fa-times me-1"></i>Close
                          </button>
                      </div>
                  `;

                  resultsDiv.innerHTML = html;
              }

              // Prevent accidental page close
              window.addEventListener('beforeunload', (e) => {
                  if (socket.connected) {
                      e.preventDefault();
                      e.returnValue = 'You have an active lab session. Are you sure you want to leave?';
                  }
              });

              // Focus terminal when clicking anywhere
              document.addEventListener('click', (e) => {
                  if (!e.target.closest('.lab-header') && !e.target.closest('button')) {
                      terminal.focus();
                  }
              });

              console.log('üß™ Secure Lab Terminal initialized');
              console.log(`üìÅ Lab Session ID: ${labSessionId}`);
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Lab Management System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f8f9fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .navbar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .navbar-brand {
        font-weight: 600;
        color: white !important;
      }

      .navbar-nav .nav-link {
        color: rgba(255, 255, 255, 0.9) !important;
        transition: all 0.3s ease;
      }

      .navbar-nav .nav-link:hover {
        color: white !important;
        transform: translateY(-1px);
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      .main-content {
        padding: 30px 0;
      }

      .course-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        padding: 25px;
        margin-bottom: 30px;
        transition: all 0.3s ease;
        border: none;
      }

      .course-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      }

      .course-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f1f3f4;
      }

      .course-code {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 8px 16px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .course-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin: 0;
      }

      .course-description {
        color: #666;
        font-size: 0.95rem;
        margin: 10px 0;
      }

      .labs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .lab-card {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .lab-card:hover {
        background: white;
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
      }

      .lab-status {
        position: absolute;
        top: 15px;
        right: 15px;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .lab-status.not-started {
        background: #e9ecef;
        color: #6c757d;
      }

      .lab-status.in-progress {
        background: #fff3cd;
        color: #856404;
      }

      .lab-status.completed {
        background: #d1edff;
        color: #0c5460;
      }

      .lab-status.submitted {
        background: #d4edda;
        color: #155724;
      }

      .lab-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        padding-right: 80px;
      }

      .lab-description {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 15px;
        line-height: 1.5;
      }

      .lab-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        font-size: 0.85rem;
      }

      .lab-difficulty {
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 500;
      }

      .lab-difficulty.easy {
        background: #d4edda;
        color: #155724;
      }

      .lab-difficulty.medium {
        background: #fff3cd;
        color: #856404;
      }

      .lab-difficulty.hard {
        background: #f8d7da;
        color: #721c24;
      }

      .lab-deadline {
        color: #666;
      }

      .lab-deadline.overdue {
        color: #dc3545;
        font-weight: 600;
      }

      .lab-actions {
        display: flex;
        gap: 10px;
      }

      .btn-lab {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
      }

      .btn-start {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .btn-start:hover {
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        color: white;
      }

      .btn-continue {
        background: #ffc107;
        color: #333;
      }

      .btn-continue:hover {
        background: #ffb300;
        transform: translateY(-1px);
        color: #333;
      }

      .btn-review {
        background: #6c757d;
        color: white;
      }

      .btn-review:hover {
        background: #5a6268;
        transform: translateY(-1px);
        color: white;
      }

      .score-badge {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }

      .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .stats-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      .stats-number {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
      }

      .stats-label {
        color: #666;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .modal-content {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0;
        border: none;
      }

      .modal-title {
        font-weight: 600;
      }

      .btn-close {
        filter: invert(1);
      }

      .course-card-modal {
        border: 1px solid #e9ecef;
        border-radius: 10px;
        transition: all 0.3s ease;
      }

      .course-card-modal:hover {
        border-color: #667eea;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
      }

      .spinner-border {
        width: 2rem;
        height: 2rem;
      }
    </style>
  </head>
  <body>
    <!-- Loading Screen -->
    <div
      id="loadingScreen"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        align-items: center;
        justify-content: center;
      "
    >
      <div style="text-align: center; color: white">
        <div
          class="spinner-border"
          role="status"
          style="
            width: 4rem;
            height: 4rem;
            border-width: 0.3rem;
            border-color: #667eea;
            border-right-color: transparent;
          "
        >
          <span class="visually-hidden">Loading...</span>
        </div>
        <h3 style="margin-top: 20px; font-weight: 600">
          Starting Lab Environment
        </h3>
        <p style="margin-top: 10px; color: rgba(255, 255, 255, 0.7)">
          Please wait while we prepare your lab...
        </p>
        <div style="margin-top: 20px">
          <div
            class="progress"
            style="
              width: 300px;
              height: 8px;
              margin: 0 auto;
              background: rgba(255, 255, 255, 0.2);
            "
          >
            <div
              class="progress-bar progress-bar-striped progress-bar-animated"
              role="progressbar"
              style="
                width: 100%;
                background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
              "
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('dashboard') }}">
          <i class="fas fa-flask me-2"></i>
          Lab Management System
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link active" href="{{ url_for('dashboard') }}">
                <i class="fas fa-tachometer-alt me-1"></i>Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showEnrollModal()">
                <i class="fas fa-plus me-1"></i>Enroll Course
              </a>
            </li>
            {% if session.user.role == 'admin' %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                <i class="fas fa-cog me-1"></i>Admin Panel
              </a>
            </li>
            {% endif %}
          </ul>

          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle d-flex align-items-center"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                {% if session.user.avatar_url %}
                <img
                  src="{{ session.user.avatar_url }}"
                  alt="Avatar"
                  class="user-avatar me-2"
                />
                {% else %}
                <i class="fas fa-user-circle me-2"></i>
                {% endif %} {{ session.user.full_name }}
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="{{ url_for('profile') }}"
                    ><i class="fas fa-user me-2"></i>Profile</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('settings') }}"
                    ><i class="fas fa-cog me-2"></i>Settings</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('logout') }}"
                    ><i class="fas fa-sign-out-alt me-2"></i>Logout</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <div class="container">
        <!-- Page Header -->
        <div class="row mb-4">
          <div class="col">
            <h1 class="h3 mb-3">
              <i class="fas fa-tachometer-alt me-2"></i>
              Welcome back, {{ session.user.full_name.split(' ')[0] }}!
            </h1>
            <p class="text-muted">
              Here's an overview of your enrolled courses and lab progress.
            </p>
          </div>
        </div>

        <!-- Statistics -->
        {% if enrolled_courses %}
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="stats-card">
              <div class="stats-number">{{ enrolled_courses|length }}</div>
              <div class="stats-label">Enrolled Courses</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <div class="stats-number">
                {% set total_labs = 0 %} {% for course_info in enrolled_courses
                %} {% set total_labs = total_labs + course_info.labs|length %}
                {% endfor %} {{ total_labs }}
              </div>
              <div class="stats-label">Total Labs</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <div class="stats-number">
                {% set completed_labs = [] %} {% for course_info in
                enrolled_courses %} {% for lab in course_info.labs %} {% if
                lab.status == 'completed' %} {% set _ =
                completed_labs.append(lab) %} {% endif %} {% endfor %} {% endfor
                %} {{ completed_labs|length }}
              </div>
              <div class="stats-label">Completed Labs</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <div class="stats-number">
                {% set in_progress_labs = [] %} {% for course_info in
                enrolled_courses %} {% for lab in course_info.labs %} {% if
                lab.status == 'in_progress' %} {% set _ =
                in_progress_labs.append(lab) %} {% endif %} {% endfor %} {%
                endfor %} {{ in_progress_labs|length }}
              </div>
              <div class="stats-label">In Progress</div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %} {% for category, message in messages %}
        <div
          class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
          ></button>
        </div>
        {% endfor %} {% endif %} {% endwith %}

        <!-- Courses and Labs -->
        {% if enrolled_courses %} {% for course_info in enrolled_courses %}
        <div class="course-card">
          <div class="course-header">
            <div>
              <span class="course-code">{{ course_info.course.code }}</span>
              <h3 class="course-title mt-2">{{ course_info.course.name }}</h3>
              {% if course_info.course.description %}
              <p class="course-description">
                {{ course_info.course.description }}
              </p>
              {% endif %}
              <small class="text-muted">
                <i class="fas fa-calendar me-1"></i>{{
                course_info.course.semester }}
                <i class="fas fa-user-tie ms-3 me-1"></i>Instructor
              </small>
            </div>
          </div>

          {% if course_info.labs %}
          <div class="labs-grid">
            {% for lab in course_info.labs %}
            <div class="lab-card">
              <div class="lab-status {{ lab.status }}">
                {% if lab.status == 'not_started' %} Not Started {% elif
                lab.status == 'in_progress' %} In Progress {% elif lab.status ==
                'completed' %} Completed {% elif lab.status == 'submitted' %}
                Submitted {% endif %}
              </div>

              <h5 class="lab-title">{{ lab.name }}</h5>
              <p class="lab-description">{{ lab.description }}</p>

              <div class="lab-meta">
                <span class="lab-difficulty {{ lab.difficulty }}">
                  <i class="fas fa-signal me-1"></i>{{ lab.difficulty|title }}
                </span>
                {% if lab.estimated_duration %}
                <span class="text-muted">
                  <i class="fas fa-clock me-1"></i>{{ lab.estimated_duration
                  }}min
                </span>
                {% endif %}
              </div>

              {% if lab.deadline %}
              <div
                class="lab-deadline {% if lab.deadline and current_time and lab.deadline < current_time %}overdue{% endif %} mb-3"
              >
                <i class="fas fa-calendar-alt me-1"></i>
                Due: {{ lab.deadline.strftime('%b %d, %Y at %I:%M %p') }}
              </div>
              {% endif %} {% if lab.score %}
              <div class="mb-3">
                <span class="score-badge">
                  <i class="fas fa-star me-1"></i>{{ lab.score }}/{{
                  lab.max_score }}
                </span>
              </div>
              {% endif %}

              <div class="lab-actions">
                {% if lab.status == 'not_started' %}
                <button
                  class="btn btn-lab btn-start"
                  onclick="startLab({{ lab.id }})"
                >
                  <i class="fas fa-play me-1"></i>Start Lab
                </button>
                {% elif lab.status == 'in_progress' %}
                <button
                  class="btn btn-lab btn-continue"
                  onclick="continueLab({{ lab.id }})"
                >
                  <i class="fas fa-play me-1"></i>Continue
                </button>
                {% elif lab.status in ['completed', 'submitted'] %}
                <button
                  class="btn btn-lab btn-review"
                  onclick="reviewLab({{ lab.id }})"
                >
                  <i class="fas fa-eye me-1"></i>Review
                </button>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="empty-state">
            <i class="fas fa-flask"></i>
            <h5>No labs available</h5>
            <p>Labs will appear here when they are added to this course.</p>
          </div>
          {% endif %}
        </div>
        {% endfor %} {% else %}
        <div
          style="display: flex; flex-direction: column; align-items: center"
          class="empty-state"
        >
          <i class="fas fa-graduation-cap"></i>
          <h4>No courses enrolled yet</h4>
          <p>
            You haven't enrolled in any courses. Click "Enroll Course" to get
            started!
          </p>
          <button
            style="display: flex; align-items: center; width: fit-content"
            class="btn btn-start mt-3"
            onclick="showEnrollModal()"
          >
            <i
              style="font-size: 2rem; margin-bottom: 0px"
              class="fas fa-plus me-2"
            ></i>
            <span>Enroll in a Course</span>
          </button>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Course Enrollment Modal -->
    <div
      class="modal fade"
      id="enrollModal"
      tabindex="-1"
      aria-labelledby="enrollModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="enrollModalLabel">
              <i class="fas fa-plus-circle me-2"></i>Enroll in a Course
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="coursesLoading" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading courses...</span>
              </div>
              <p class="mt-2">Loading available courses...</p>
            </div>

            <div id="coursesContainer" style="display: none">
              <div class="row" id="coursesList">
                <!-- Courses will be loaded here -->
              </div>
            </div>

            <div
              id="noCoursesMessage"
              style="display: none"
              class="text-center py-4"
            >
              <i class="fas fa-graduation-cap fa-3x text-muted mb-3"></i>
              <h5>No courses available</h5>
              <p class="text-muted">
                You are already enrolled in all available courses.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Lab management functions
      function startLab(labId) {
        // Show loading screen
        const loadingScreen = document.getElementById("loadingScreen");
        loadingScreen.style.display = "flex";

        fetch(`/api/start_lab/${labId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              loadingScreen.style.display = "none";
              alert("Error: " + data.error);
            } else {
              // Keep loading screen visible and redirect
              window.location.href = `/lab/${labId}/terminal`;
            }
          })
          .catch((error) => {
            loadingScreen.style.display = "none";
            console.error("Error starting lab:", error);
            alert("Failed to start lab. Please try again.");
          });
      }

      function continueLab(labId) {
        // Show loading screen
        const loadingScreen = document.getElementById("loadingScreen");
        loadingScreen.style.display = "flex";

        // Same as start lab - redirect to terminal
        window.location.href = `/lab/${labId}/terminal`;
      }

      function reviewLab(labId) {
        // Redirect to lab terminal in read-only mode
        window.location.href = `/lab/${labId}/terminal?mode=review`;
      }

      // Course enrollment functions
      function showEnrollModal() {
        const modal = new bootstrap.Modal(
          document.getElementById("enrollModal")
        );
        loadAvailableCourses();
        modal.show();
      }

      function loadAvailableCourses() {
        // Show loading state
        document.getElementById("coursesLoading").style.display = "block";
        document.getElementById("coursesContainer").style.display = "none";
        document.getElementById("noCoursesMessage").style.display = "none";

        fetch("/api/courses")
          .then((response) => response.json())
          .then((courses) => {
            document.getElementById("coursesLoading").style.display = "none";

            if (courses.length === 0) {
              document.getElementById("noCoursesMessage").style.display =
                "block";
            } else {
              document.getElementById("coursesContainer").style.display =
                "block";
              displayCourses(courses);
            }
          })
          .catch((error) => {
            console.error("Error loading courses:", error);
            document.getElementById("coursesLoading").innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load courses. Please try again.
                        </div>
                    `;
          });
      }

      function displayCourses(courses) {
        const coursesList = document.getElementById("coursesList");
        coursesList.innerHTML = "";

        courses.forEach((course) => {
          const courseCard = `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="badge bg-primary">${
                                      course.code
                                    }</span>
                                    <small class="text-muted">${
                                      course.lab_count
                                    } labs</small>
                                </div>
                                <h6 class="card-title">${course.name}</h6>
                                <p class="card-text text-muted small">${
                                  course.description ||
                                  "No description available"
                                }</p>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>${
                                          course.semester
                                        }
                                    </small>
                                    <button class="btn btn-sm btn-primary" onclick="enrollInCourse(${
                                      course.id
                                    }, '${course.name}')">
                                        <i class="fas fa-plus me-1"></i>Enroll
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
          coursesList.innerHTML += courseCard;
        });
      }

      function enrollInCourse(courseId, courseName) {
        // Disable all enroll buttons to prevent double-click
        const enrollButtons = document.querySelectorAll(
          'button[onclick*="enrollInCourse"]'
        );
        enrollButtons.forEach((btn) => {
          btn.disabled = true;
          btn.innerHTML =
            '<i class="fas fa-spinner fa-spin me-1"></i>Enrolling...';
        });

        fetch("/api/enroll", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            course_id: courseId,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert("Error: " + data.error);
              // Re-enable buttons
              enrollButtons.forEach((btn) => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus me-1"></i>Enroll';
              });
            } else {
              // Success - show message and reload page
              alert(`Successfully enrolled in ${courseName}!`);
              window.location.reload();
            }
          })
          .catch((error) => {
            console.error("Error enrolling in course:", error);
            alert("Failed to enroll in course. Please try again.");
            // Re-enable buttons
            enrollButtons.forEach((btn) => {
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-plus me-1"></i>Enroll';
            });
          });
      }
    </script>
  </body>
</html>
